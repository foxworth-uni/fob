<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fob Playground</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #1a1a2e;
      --surface: #16213e;
      --border: #0f3460;
      --text: #e4e4e4;
      --text-dim: #888;
      --accent: #e94560;
      --success: #4ade80;
      --warning: #fbbf24;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
    }

    .logo span {
      color: var(--text);
      font-weight: 400;
    }

    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    button:hover {
      opacity: 0.9;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    button.secondary {
      background: var(--border);
    }

    main {
      display: grid;
      grid-template-columns: 1fr 1fr;
      height: calc(100vh - 65px);
    }

    .panel {
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border);
    }

    .panel:last-child {
      border-right: none;
    }

    .panel-header {
      background: var(--surface);
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      font-weight: 600;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .panel-content {
      flex: 1;
      overflow: auto;
    }

    textarea {
      width: 100%;
      height: 100%;
      background: var(--bg);
      color: var(--text);
      border: none;
      padding: 16px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 14px;
      line-height: 1.6;
      resize: none;
      outline: none;
    }

    textarea::placeholder {
      color: var(--text-dim);
    }

    pre {
      padding: 16px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .error {
      color: var(--accent);
      background: rgba(233, 69, 96, 0.1);
      padding: 16px;
      border-radius: 4px;
      margin: 16px;
    }

    .stats-bar {
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 12px 16px;
      display: flex;
      gap: 24px;
      font-size: 13px;
    }

    .stat {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .stat-label {
      color: var(--text-dim);
    }

    .stat-value {
      font-weight: 600;
      font-family: 'SF Mono', monospace;
    }

    .stat-value.success {
      color: var(--success);
    }

    .stat-value.warning {
      color: var(--warning);
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-dim);
    }

    .connection-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-dim);
    }

    .connection-dot.connected {
      background: var(--success);
    }

    .build-indicator {
      display: none;
      align-items: center;
      gap: 8px;
      color: var(--accent);
      font-size: 13px;
    }

    .build-indicator.active {
      display: flex;
    }

    .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .template-select {
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">fob <span>playground</span></div>
    <div class="controls">
      <select class="template-select" id="templateSelect">
        <option value="">Load template...</option>
        <option value="react-app">React App</option>
        <option value="counter">Counter</option>
        <option value="hello">Hello World</option>
      </select>
      <div class="build-indicator" id="buildIndicator">
        <div class="spinner"></div>
        <span>Compiling...</span>
      </div>
      <button id="compileBtn">Compile</button>
      <div class="connection-status">
        <div class="connection-dot" id="connectionDot"></div>
        <span id="connectionText">Disconnected</span>
      </div>
    </div>
  </header>

  <main>
    <div class="panel">
      <div class="panel-header">Input (TypeScript/JSX)</div>
      <div class="panel-content">
        <textarea id="codeInput" placeholder="// Write your code here...
export function App() {
  return <h1>Hello, Fob!</h1>;
}"></textarea>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">Output (Bundled)</div>
      <div class="panel-content">
        <pre id="codeOutput"></pre>
      </div>
      <div class="stats-bar">
        <div class="stat">
          <span class="stat-label">Duration:</span>
          <span class="stat-value" id="statDuration">-</span>
        </div>
        <div class="stat">
          <span class="stat-label">Modules:</span>
          <span class="stat-value" id="statModules">-</span>
        </div>
        <div class="stat">
          <span class="stat-label">Size:</span>
          <span class="stat-value" id="statSize">-</span>
        </div>
        <div class="stat">
          <span class="stat-label">Cache:</span>
          <span class="stat-value" id="statCache">-</span>
        </div>
      </div>
    </div>
  </main>

  <script>
    const codeInput = document.getElementById('codeInput');
    const codeOutput = document.getElementById('codeOutput');
    const compileBtn = document.getElementById('compileBtn');
    const buildIndicator = document.getElementById('buildIndicator');
    const connectionDot = document.getElementById('connectionDot');
    const connectionText = document.getElementById('connectionText');
    const templateSelect = document.getElementById('templateSelect');

    const statDuration = document.getElementById('statDuration');
    const statModules = document.getElementById('statModules');
    const statSize = document.getElementById('statSize');
    const statCache = document.getElementById('statCache');

    // Default code
    codeInput.value = `// Interactive Fob Playground
// Edit this code and click "Compile" to see the bundled output

export function greet(name: string): string {
  return \`Hello, \${name}!\`;
}

export function App() {
  const message = greet('Fob');
  return <div>{message}</div>;
}

console.log(greet('World'));
`;

    // Compile function
    async function compile() {
      const code = codeInput.value;
      if (!code.trim()) return;

      compileBtn.disabled = true;
      buildIndicator.classList.add('active');
      codeOutput.textContent = '';

      try {
        const response = await fetch('/api/compile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code, filename: 'main.tsx' }),
        });

        const result = await response.json();

        if (result.error) {
          codeOutput.innerHTML = `<div class="error">${escapeHtml(result.error)}</div>`;
        } else {
          codeOutput.textContent = result.output;
          updateStats(result.stats);
        }
      } catch (error) {
        codeOutput.innerHTML = `<div class="error">Network error: ${escapeHtml(error.message)}</div>`;
      } finally {
        compileBtn.disabled = false;
        buildIndicator.classList.remove('active');
      }
    }

    // Update stats display
    function updateStats(stats) {
      statDuration.textContent = `${stats.duration}ms`;
      statDuration.className = 'stat-value ' + (stats.duration < 100 ? 'success' : stats.duration < 500 ? '' : 'warning');

      statModules.textContent = stats.modules;
      statSize.textContent = formatBytes(stats.size);

      const cachePercent = Math.round((stats.cacheHitRate || 0) * 100);
      statCache.textContent = `${cachePercent}%`;
      statCache.className = 'stat-value ' + (cachePercent > 50 ? 'success' : '');
    }

    // Format bytes
    function formatBytes(bytes) {
      if (bytes < 1024) return `${bytes} B`;
      if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
      return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Load template
    async function loadTemplate(name) {
      if (!name) return;

      try {
        const response = await fetch(`/api/templates/${name}`);
        const result = await response.json();

        if (result.content) {
          codeInput.value = result.content;
        }
      } catch (error) {
        console.error('Failed to load template:', error);
      }

      templateSelect.value = '';
    }

    // SSE connection for live updates
    function connectSSE() {
      const eventSource = new EventSource('/api/sse');

      eventSource.addEventListener('connected', () => {
        connectionDot.classList.add('connected');
        connectionText.textContent = 'Connected';
      });

      eventSource.addEventListener('build', (event) => {
        const data = JSON.parse(event.data);
        if (data.success) {
          updateStats({
            duration: data.duration,
            modules: data.modules,
            size: data.size,
            cacheHitRate: data.cacheHitRate,
          });
        }
      });

      eventSource.onerror = () => {
        connectionDot.classList.remove('connected');
        connectionText.textContent = 'Reconnecting...';
        eventSource.close();
        setTimeout(connectSSE, 3000);
      };
    }

    // Event listeners
    compileBtn.addEventListener('click', compile);
    templateSelect.addEventListener('change', (e) => loadTemplate(e.target.value));

    // Keyboard shortcut: Cmd/Ctrl + Enter to compile
    codeInput.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
        e.preventDefault();
        compile();
      }
    });

    // Start SSE connection
    connectSSE();
  </script>
</body>
</html>
