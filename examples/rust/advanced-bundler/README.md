# Advanced Bundler Example

A comprehensive example demonstrating production-ready bundling patterns with fob-core.

## What This Example Shows

- **Multiple entry points** - Build app.js and worker.js simultaneously
- **Code splitting** - Extract shared code into common chunks
- **Multiple output formats** - ESM, CommonJS, and IIFE
- **External dependencies** - Mark packages as external (not bundled)
- **Path aliases** - Use `@lib/` instead of relative paths
- **Production optimizations** - Minification, source maps, tree shaking

## Project Structure

```
advanced-bundler/
├── src/
│   └── main.rs          # Rust bundler code
├── input/
│   ├── app.js           # Main app entry
│   ├── worker.js        # Worker entry
│   ├── config.js        # Shared config
│   └── lib/
│       ├── math.js      # Math utilities
│       └── format.js    # Formatting utilities
├── output/              # Generated by build
│   ├── esm/             # ES modules with code splitting
│   ├── cjs/             # CommonJS for Node.js
│   └── iife/            # IIFE for browsers
└── Cargo.toml
```

## Running the Example

### Build All Bundles

```bash
cargo run
```

This creates three different bundle formats:

1. **ESM** (`output/esm/`) - Modern ES modules with code splitting
2. **CJS** (`output/cjs/`) - CommonJS for Node.js
3. **IIFE** (`output/iife/`) - Self-executing function for browsers

### Run the Bundles

```bash
# Run CommonJS bundle in Node.js
node output/cjs/app.js

# Run ESM bundle (requires Node.js with ES modules support)
node output/esm/app.js

# IIFE bundle is for browsers - open in HTML file
```

## Key Features Explained

### 1. Multiple Entry Points

Building multiple files at once:

```rust
BuildOptions::app(["input/app.js", "input/worker.js"])
```

**Benefits:**
- Build everything in one pass
- Shared code automatically extracted
- Faster than building separately
- Optimal chunk splitting

### 2. Code Splitting

When enabled, shared code is extracted into separate chunks:

```rust
.splitting(true)
```

**Result:**
```
output/esm/
├── app.js           # App-specific code
├── worker.js        # Worker-specific code
└── shared-abc123.js # Shared code (math, format, config)
```

**Benefits:**
- Smaller individual files
- Better caching (shared code cached once)
- Parallel loading
- Reduced duplication

### 3. Output Formats

#### ESM (ES Modules)

```rust
.format(OutputFormat::Esm)
```

**Use for:**
- Modern browsers
- Node.js (with `"type": "module"`)
- Bundlers (Webpack, Rollup, etc.)

**Features:**
- `import`/`export` syntax
- Tree shaking support
- Static analysis

#### CJS (CommonJS)

```rust
.format(OutputFormat::Cjs)
```

**Use for:**
- Node.js (traditional)
- Older build tools
- Maximum compatibility

**Features:**
- `require()`/`module.exports`
- Synchronous loading
- Wide support

#### IIFE (Immediately Invoked Function Expression)

```rust
.format(OutputFormat::Iife)
```

**Use for:**
- Browsers without module system
- `<script>` tags
- Legacy environments

**Features:**
- Self-executing
- No module system needed
- Global variable exposure

### 4. External Dependencies

Mark packages as external (not bundled):

```rust
.external(["lodash"])
```

**Use cases:**
- Peer dependencies
- CDN-hosted libraries
- Packages provided by environment
- Reduce bundle size

### 5. Path Aliases

Clean import paths:

```rust
.path_alias("@lib", "./input/lib")
```

**Before:**
```javascript
import { add } from '../../lib/math.js';
```

**After:**
```javascript
import { add } from '@lib/math';
```

**Benefits:**
- Cleaner code
- Easier refactoring
- No relative path hell
- Better IDE support

## Build Configuration Comparison

| Feature | ESM Build | CJS Build | IIFE Build |
|---------|-----------|-----------|------------|
| Entry points | 2 (app + worker) | 1 (app only) | 1 (app only) |
| Code splitting | ✅ Yes | ❌ No | ❌ No |
| Minification | ✅ Yes | ❌ No | ✅ Yes |
| Source maps | ✅ Yes | ✅ Yes | ✅ Yes |
| External deps | ✅ lodash | ❌ None | ❌ None |
| Use case | Modern apps | Node.js | Legacy browsers |

## Real-World Use Cases

### ESM Build

Perfect for:
- Modern web applications
- Micro-frontends
- Progressive web apps
- npm packages (modern)

### CJS Build

Perfect for:
- Node.js libraries
- CLI tools
- Serverless functions
- Legacy npm packages

### IIFE Build

Perfect for:
- Browser extensions
- Bookmarklets
- Embedded widgets
- CDN distribution

## Performance Tips

### Enable Code Splitting

For multiple entry points, always enable splitting:

```rust
.splitting(true)
```

**Impact:** 30-50% smaller total size for multi-entry builds

### Use External Dependencies

Don't bundle large libraries:

```rust
.external(["react", "react-dom", "lodash"])
```

**Impact:** 100-500KB+ size reduction

### Enable Minification

For production builds:

```rust
.minify(true)
```

**Impact:** 30-50% size reduction

### Use Path Aliases

Improves tree shaking:

```rust
.path_alias("@lib", "./lib")
```

**Impact:** Better dead code elimination

## Troubleshooting

### Code splitting not working

Make sure you have:
1. Multiple entry points
2. `.splitting(true)` enabled
3. Shared code between entries

### External dependencies not working

Check that:
1. Package name matches exactly
2. Package is imported in the code
3. Package exists in node_modules (for resolution)

### IIFE bundle not executing

Ensure you're loading it in a browser context:

```html
<script src="output/iife/app.js"></script>
```

## Next Steps

After mastering advanced bundling:

1. **component-library** - Build React component libraries
2. **meta-framework** - File-based routing and SSR
3. Explore custom plugins and transformations

## Learn More

- [fob-core documentation](../../../crates/fob-core/)
- [Basic bundler example](../basic-bundler/)
- [Component library example](../component-library/)

